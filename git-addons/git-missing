#!/bin/sh
# Copyright (c) 2012-2013, John Szakmeister <john@szakmeister.net>
#
# Output similar to 'bzr missing'.  It shows which revisions you have that the
# other branch doesn't, as well as revision the other branch has that you don't.
# Usage:
#     git missing => compares to upstream
#     git missing <target> => compares HEAD to <target>
#     git missing <source> <target> => compares <source> to <target>

SUBDIRECTORY_OK=1 . "$(git --exec-path)/git-sh-setup" ||
    die "Not a git repository."

firstbranch=$1
secondbranch=$2

if test -z "$firstbranch"; then
    # Compare against the tracking branch...
    tracking_branch=$(git rev-parse --revs-only @{u} 2>/dev/null)
    test -z "$tracking_branch" &&
        die "Can't infer branch to compare to. At least one branch required"
    firstbranch=$tracking_branch
fi

git rev-parse $firstbranch -- > /dev/null 2>&1 ||
    die "Invalid branch or rev: $firstbranch"

if test -z "$secondbranch"; then
    secondbranch=$firstbranch
    firstbranch=
else
    git rev-parse $secondbranch -- > /dev/null 2>&1 ||
        die "Invalid branch or rev: $secondbranch"
fi

log_options="--pretty=oneline --abbrev-commit"

git config --get-colorbool color.missing &&
    log_options="$log_options --color=always"

cmd_missing()
{
    local extra=$(git rev-list --count --cherry-pick --right-only --no-merges $secondbranch...$firstbranch)
    local missing=$(git rev-list --count --cherry-pick --left-only --no-merges $secondbranch...$firstbranch)
    local output=0

    if [ "$extra" != "0" ]; then
        output=1

        line="You have $extra extra revisions"
        echo $line
        echo $line | sed -e 's/./-/g'
        git log $log_options --cherry-pick --right-only --no-merges $secondbranch...$firstbranch
    fi

    if [ "$missing" != "0" ]; then
        if [ "$extra" != "0" ]; then
            echo; echo
        fi

        output=1

        line="You have $missing missing revisions"
        echo $line
        echo $line | sed -e 's/./-/g'
        git log $log_options --cherry-pick --left-only --no-merges $secondbranch...$firstbranch
    fi

    if [ $output != "0" ]; then
        echo
    fi
}

cmd_missing | git_pager
